# Development override for docker-compose.yml
# This enables hot-reload with bind mounts

services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    # Override entrypoint to use shell instead of java -jar
    entrypoint: []
    volumes:
      # Full bind mount for development
      - ../:/app:rw
      # Exclude build directories to avoid sync overhead
      - /app/build
      - /app/.gradle
      # Mount Gradle cache from host for faster builds
      # This persists Gradle cache between container restarts
      - gradle_cache:/root/.gradle/caches
      - gradle_wrapper:/root/.gradle/wrapper
    environment:
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "true"
      # Enable Gradle daemon and optimizations for faster builds
      GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true"
      # Reduce Gradle log verbosity for faster startup
      GRADLE_LOG_LEVEL: "warn"
    # Override command for development with smart DB waiting
    # Optimized: Simplified checks, faster startup
    command: >
      sh -c "
        echo '[*] Waiting for MariaDB...' &&
        wait-for-it mariadb:3306 --timeout=60 --strict -- &&
        echo '[OK] MariaDB is ready!' &&
        echo '[*] Starting Spring Boot (dependencies cached in volume)...' &&
        cd /app &&
        gradle bootRun --continuous --parallel
      "

volumes:
  gradle_cache:
    driver: local
  gradle_wrapper:
    driver: local

