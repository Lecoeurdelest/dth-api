# Development override for docker-compose.yml
# This enables hot-reload with bind mounts

services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    # Override entrypoint to use shell instead of java -jar
    entrypoint: []
    volumes:
      # Full bind mount for development
      - ../:/app:rw
      # Exclude build directories to avoid sync overhead
      - /app/build
      - /app/.gradle
      # Mount Gradle cache from host for faster builds
      # This persists Gradle cache between container restarts
      - gradle_cache:/root/.gradle/caches
      - gradle_wrapper:/root/.gradle/wrapper
    environment:
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "true"
      # Enable Gradle daemon for faster builds
      GRADLE_OPTS: "-Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
    # Override command for development with smart DB waiting
    command: >
      sh -c "
        echo '=== Checking Gradle setup ===' &&
        if [ ! -f /app/build.gradle.kts ]; then
          echo 'ERROR: build.gradle.kts not found in /app' &&
          echo 'Current directory: $(pwd)' &&
          echo 'Files in /app:' &&
          ls -la /app/ | head -20 &&
          exit 1
        fi &&
        if [ ! -f /app/settings.gradle.kts ]; then
          echo 'ERROR: settings.gradle.kts not found in /app' &&
          exit 1
        fi &&
        if [ ! -d /app/gradle ]; then
          echo 'ERROR: gradle/ directory not found in /app' &&
          exit 1
        fi &&
        echo '✅ Gradle files found' &&
        echo '=== Waiting for MariaDB ===' &&
        wait-for-it mariadb:3306 --timeout=60 --strict -- &&
        echo '✅ MariaDB is ready!' &&
        echo '=== Checking source code ===' &&
        if [ -d /app/src/main/java ]; then
          echo '✅ Source directory exists' &&
          ls -la /app/src/main/java/com/example/app/ | head -5 || echo 'Warning: Application.java not found'
        else
          echo 'ERROR: Source directory /app/src/main/java does not exist!'
          exit 1
        fi &&
        echo '=== Starting Spring Boot application ===' &&
        cd /app &&
        gradle bootRun --continuous --parallel
      "

volumes:
  gradle_cache:
    driver: local
  gradle_wrapper:
    driver: local

