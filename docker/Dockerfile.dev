# syntax=docker/dockerfile:1.4
# Development Dockerfile with Gradle for hot-reload
# Optimized for fast builds on Windows/Mac/Linux
FROM gradle:8.5-jdk17

# Install all tools in one layer to reduce build time
RUN apt-get update && \
    apt-get install -y \
        curl \
        wget \
        netcat-openbsd \
    && rm -rf /var/lib/apt/lists/* \
    && wget -q -O /usr/local/bin/wait-for-it https://github.com/vishnubob/wait-for-it/raw/master/wait-for-it.sh \
    && chmod +x /usr/local/bin/wait-for-it

WORKDIR /app

# Copy Gradle files for dependency caching
# These files rarely change, so Docker will cache this layer
COPY gradle ./gradle
COPY build.gradle.kts settings.gradle.kts gradle.properties ./

# Pre-create Gradle user home directory to avoid permission issues on Windows
RUN mkdir -p /root/.gradle && \
    chmod 755 /root/.gradle

# OPTIMIZED: Skip pre-downloading dependencies during build
# Dependencies will be downloaded on first run and cached in volume (gradle_cache)
# This reduces build time from ~114s to ~2s for subsequent builds
# First run will download deps (~30-60s on Mac, ~2-4min on Windows) but they'll be cached for next runs
# 
# Alternative: If you want to pre-download (uncomment below):
# RUN --mount=type=cache,target=/root/.gradle/caches \
#     --mount=type=cache,target=/root/.gradle/wrapper \
#     gradle dependencies --no-daemon --quiet || true

# Expose port
EXPOSE 8080

# Default command - will be overridden by docker-compose
# Gradle will download dependencies on first run and cache them in volume
CMD ["gradle", "bootRun", "--continuous", "--parallel"]
