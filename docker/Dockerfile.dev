# syntax=docker/dockerfile:1.4
# Development Dockerfile with Gradle for hot-reload
# Optimized for fast builds, runs, and hot reload on Windows/Mac/Linux
FROM gradle:8.5-jdk17

# Install all tools in one layer to reduce build time
RUN apt-get update && \
    apt-get install -y \
        curl \
        wget \
        netcat-openbsd \
    && rm -rf /var/lib/apt/lists/* \
    && wget -q -O /usr/local/bin/wait-for-it https://github.com/vishnubob/wait-for-it/raw/master/wait-for-it.sh \
    && chmod +x /usr/local/bin/wait-for-it

WORKDIR /app

# Copy Gradle files for dependency caching
# These files rarely change, so Docker will cache this layer
COPY gradle ./gradle
COPY build.gradle.kts settings.gradle.kts gradle.properties ./

# Pre-create Gradle user home directory to avoid permission issues on Windows
RUN mkdir -p /root/.gradle && \
    chmod 755 /root/.gradle

# OPTIMIZED STRATEGY: Skip pre-download in Dockerfile (fast build)
# Dependencies will be downloaded on first run and cached in Docker volume
# This makes build fast (~2s on Mac, ~5s on Windows) and first run downloads deps (~30s-2min)
# Subsequent runs are very fast because dependencies are cached in volume
# Trade-off: First container run slower, but all subsequent runs (and rebuilds) are fast

# Expose port
EXPOSE 8080

# Default command - will be overridden by docker-compose
CMD ["gradle", "bootRun", "--continuous", "--parallel"]
